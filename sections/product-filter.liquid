{% liquid
  assign max_items = section.settings.max_products
  assign products_to_display = section.settings.collection.products | default: empty
%}

<!-- Prepare products data for filter component -->
<script>
  {% assign safe_id = section.id | replace: "-", "_" %}
  const allProductsData_{{ safe_id }} = [
    {% if section.settings.collection %}
      {% paginate section.settings.collection.products by 250 %}
        {% for product in section.settings.collection.products %}
          {
            id: "{{ product.id }}",
            title: "{{ product.title | escape }}",
            handle: "{{ product.handle }}",
            price: {{ product.price | divided_by: 100.0 }},
            image: "{{ product.featured_image | image_url: width: 300 }}",
            type: "{{ product.type | strip | escape }}",
            vendor: "{{ product.vendor | escape }}",
            url: "{{ product.url }}"
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% endpaginate %}
    {% else %}
      {% paginate shop.products by 250 %}
        {% for product in shop.products %}
          {
            id: "{{ product.id }}",
            title: "{{ product.title | escape }}",
            handle: "{{ product.handle }}",
            price: {{ product.price | divided_by: 100.0 }},
            image: "{{ product.featured_image | image_url: width: 300 }}",
            type: "{{ product.type | strip | escape }}",
            vendor: "{{ product.vendor | escape }}",
            url: "{{ product.url }}"
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% endpaginate %}
    {% endif %}
  ];
 
  console.log('=== PRODUCT DATA DEBUG ({{ section.id }}) ===');
  console.log('Total products:', allProductsData_{{ safe_id }}.length);
  console.log('Product types found:', [...new Set(allProductsData_{{ safe_id }}.map(p => p.type))]);
</script>

<div class="pf-section-{{ section.id }}" style="
  padding-top: {{ section.settings.padding-block-start }}px;
  padding-bottom: {{ section.settings.padding-block-end }}px;
">
  <div class="pf-container-{{ section.id }}" style="
    max-width: {% if section.settings.section_width == 'page-width' %}1200px{% else %}100%{% endif %};
    margin: 0 auto;
    padding: 0 20px;
  ">
    
    <!-- BLOCKS: Header area with flexible layout -->
    {% if section.blocks.size > 0 %}
      {% assign header_layout = 'horizontal' %}
      {% assign header_alignment = 'space-between' %}
      {% assign header_gap = 15 %}
      
      {% comment %} Get layout from first block if it has layout settings {% endcomment %}
      {% for block in section.blocks %}
        {% if block.type == 'collection_title' and block.settings.layout %}
          {% assign header_layout = block.settings.layout %}
        {% endif %}
        {% if block.type == 'collection_title' and block.settings.alignment %}
          {% assign header_alignment = block.settings.alignment %}
        {% endif %}
        {% if block.type == 'collection_title' and block.settings.gap %}
          {% assign header_gap = block.settings.gap %}
        {% endif %}
      {% endfor %}

      <div class="pf-header-{{ section.id }}" style="
        display: flex;
        flex-direction: {% if header_layout == 'vertical' %}column{% else %}row{% endif %};
        justify-content: {{ header_alignment }};
        align-items: {% if header_layout == 'vertical' %}flex-start{% else %}center{% endif %};
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: {{ header_gap }}px;
      ">
        {% for block in section.blocks %}
          {% case block.type %}
            
            {% when 'collection_title' %}
              <div {{ block.shopify_attributes }} style="
                {% if header_layout == 'horizontal' %}flex: 1;{% endif %}
                text-align: {{ block.settings.title_alignment }};
              ">
                {% if section.settings.collection %}
                  <h2 style="
                    margin: 0;
                    font-size: {{ block.settings.heading_size }}px;
                    font-weight: 700;
                    color: inherit;
                  ">
                    {{ section.settings.collection.title }}
                  </h2>
                {% else %}
                  <h2 style="
                    margin: 0;
                    font-size: {{ block.settings.heading_size }}px;
                    font-weight: 700;
                    color: #999;
                  ">
                    Select a collection
                  </h2>
                {% endif %}
              </div>

            {% when 'view_all_button' %}
              <div {{ block.shopify_attributes }} style="
                text-align: {{ block.settings.button_alignment }};
                {% if header_layout == 'vertical' %}width: 100%;{% endif %}
              ">
                {% if section.settings.collection %}
                  <a href="{{ section.settings.collection.url }}" style="
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: {{ block.settings.button_padding_vertical }}px {{ block.settings.button_padding_horizontal }}px;
                    background: {{ block.settings.button_bg_color }};
                    color: {{ block.settings.button_text_color }};
                    text-decoration: none;
                    border-radius: {{ block.settings.button_border_radius }}px;
                    font-weight: 600;
                    font-size: {{ block.settings.button_font_size }}px;
                    transition: all 0.3s ease;
                    border: {{ block.settings.button_border_width }}px solid {{ block.settings.button_border_color }};
                  " 
                  onmouseover="this.style.background='{{ block.settings.button_bg_color_hover }}'; this.style.color='{{ block.settings.button_text_color_hover }}';" 
                  onmouseout="this.style.background='{{ block.settings.button_bg_color }}'; this.style.color='{{ block.settings.button_text_color }}';">
                    {{ block.settings.button_text }}
                    {% if block.settings.show_arrow %}
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    {% endif %}
                  </a>
                {% endif %}
              </div>

          {% endcase %}
        {% endfor %}
      </div>
    {% endif %}

    <!-- PRODUCT FILTER COMPONENT -->
    <script src="{{ 'product-filter.js' | asset_url }}"></script>
    <product-filter id="product-filter-{{ section.id }}"></product-filter>
    
    <!-- Pass data to filter after it loads -->
    <script>
      function initializeFilter_{{ safe_id }}() {
        const productFilter = document.getElementById('product-filter-{{ section.id }}');
        if (productFilter && typeof allProductsData_{{ safe_id }} !== 'undefined' && allProductsData_{{ safe_id }}.length > 0) {
          productFilter.setAttribute('data-products', JSON.stringify(allProductsData_{{ safe_id }}));
          console.log('‚úÖ Filter initialized ({{ section.id }}) with ' + allProductsData_{{ safe_id }}.length + ' products');
        } else if (productFilter) {
          setTimeout(initializeFilter_{{ safe_id }}, 100);
        }
      }
     
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeFilter_{{ safe_id }});
      } else {
        initializeFilter_{{ safe_id }}();
      }
    </script>

    <!-- FILTERED PRODUCTS DISPLAY CONTAINER -->
    <div id="filtered-products-container-{{ section.id }}" class="pf-products-wrapper">
      <div id="products-grid-{{ section.id }}" class="pf-products-grid">
        {% if section.settings.collection != blank %}
          {% paginate section.settings.collection.products by 250 %}
            {% for product in section.settings.collection.products %}
              <div
                class="pf-product-card"
                data-product-id="{{ product.id }}"
                data-product-type="{{ product.type | strip | escape }}"
                data-product-title="{{ product.title | escape | downcase }}"
                data-product-price="{{ product.price | divided_by: 100.0 }}"
              >
                <a href="{{ product.url }}" class="pf-product-link" style="text-decoration: none; color: inherit;">
                  <div class="pf-product-image-container">
                    {% if product.featured_image %}
                      <img
                        src="{{ product.featured_image | image_url: width: 300 }}"
                        alt="{{ product.featured_image.alt | escape }}"
                        class="pf-product-image"
                        loading="lazy"
                      >
                    {% endif %}
                  </div>
                  <div class="pf-product-info">
                    <h3 class="pf-product-title">{{ product.title }}</h3>
                    <div class="pf-product-type">{{ product.type }}</div>
                    <div class="pf-product-price">${{ product.price | divided_by: 100.0 }}</div>
                  </div>
                </a>
              </div>
            {% endfor %}
          {% endpaginate %}
        {% else %}
          {% paginate shop.products by 250 %}
            {% for product in shop.products %}
              <div
                class="pf-product-card"
                data-product-id="{{ product.id }}"
                data-product-type="{{ product.type | strip | escape }}"
                data-product-title="{{ product.title | escape | downcase }}"
                data-product-price="{{ product.price | divided_by: 100.0 }}"
              >
                <a href="{{ product.url }}" class="pf-product-link" style="text-decoration: none; color: inherit;">
                  <div class="pf-product-image-container">
                    {% if product.featured_image %}
                      <img
                        src="{{ product.featured_image | image_url: width: 300 }}"
                        alt="{{ product.featured_image.alt | escape }}"
                        class="pf-product-image"
                        loading="lazy"
                      >
                    {% endif %}
                  </div>
                  <div class="pf-product-info">
                    <h3 class="pf-product-title">{{ product.title }}</h3>
                    <div class="pf-product-type">{{ product.type }}</div>
                    <div class="pf-product-price">${{ product.price | divided_by: 100.0 }}</div>
                  </div>
                </a>
              </div>
            {% endfor %}
          {% endpaginate %}
        {% endif %}
      </div>
      
      <!-- No results message -->
      <div id="no-results-message-{{ section.id }}" style="display: none; text-align: center; padding: 40px 20px; color: #999;">
        <p>No products match your filters. Please try adjusting your selections.</p>
      </div>
    </div>

    <!-- Styling for product grid -->
    <style>
      .pf-products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: {{ section.settings.gap }}px;
        margin-top: 30px;
      }
      .pf-product-card {
        background: #fff;
        border: 1px solid #eaeaea;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
      }
      .pf-product-card:hover {
        box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        border-color: transparent;
        transform: translateY(-5px);
      }
      .pf-product-link {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .pf-product-image-container {
        width: 100%;
        height: 280px;
        overflow: hidden;
        background: #f9f9f9;
        position: relative;
      }
      .pf-product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s ease;
      }
      .pf-product-card:hover .pf-product-image {
        transform: scale(1.08);
      }
      .pf-product-info {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .pf-product-title {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
        color: #111;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .pf-product-type {
        font-size: 11px;
        color: #888;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }
      .pf-product-price {
        font-size: 16px;
        font-weight: 700;
        color: #000;
        margin-top: auto;
      }
      @media (max-width: 768px) {
        .pf-products-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }
        .pf-product-image-container {
          height: 200px;
        }
        .pf-product-info {
          padding: 12px;
        }
        .pf-product-title {
          font-size: 14px;
        }
      }
      .pf-pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
      }
      .pf-pagination-btn {
        width: 44px;
        height: 44px;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid #e0e0e0;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        font-size: 18px;
      }
      .pf-pagination-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        border-color: #eee;
      }
      .pf-pagination-btn:not(:disabled):hover {
        border-color: #000;
        background: #000;
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .pf-pagination-info {
        font-size: 14px;
        color: #666;
        font-weight: 500;
        min-width: 100px;
        text-align: center;
      }
    </style>
   
    <div class="pf-pagination-container" id="pagination-container-{{ section.id }}" style="display: none;">
      <button class="pf-pagination-btn" id="prev-btn-{{ section.id }}" aria-label="Previous Page">‚Üê</button>
      <span class="pf-pagination-info" id="pagination-info-{{ section.id }}">Page 1 of 1</span>
      <button class="pf-pagination-btn" id="next-btn-{{ section.id }}" aria-label="Next Page">‚Üí</button>
    </div>

    <!-- Filter Event Handlers -->
    <script>
      function setupFilterListeners_{{ safe_id }}() {
        const productFilter = document.getElementById('product-filter-{{ section.id }}');
        const noResultsMessage = document.getElementById('no-results-message-{{ section.id }}');
        const paginationContainer = document.getElementById('pagination-container-{{ section.id }}');
        const prevBtn = document.getElementById('prev-btn-{{ section.id }}');
        const nextBtn = document.getElementById('next-btn-{{ section.id }}');
        const paginationInfo = document.getElementById('pagination-info-{{ section.id }}');

        if (!productFilter) {
          console.error('‚ùå Product filter not found for section: {{ section.id }}');
          return;
        }

        console.log('‚úÖ Setting up filter listeners for section: {{ section.id }}');

        let allCards = [];
        let visibleCards = [];
        let currentPage = 1;
        const itemsPerPage = {{ section.settings.max_products | default: 12 }};

        allCards = Array.from(document.querySelectorAll('#products-grid-{{ section.id }} .pf-product-card'));
       
        function renderPage() {
          const totalPages = Math.ceil(visibleCards.length / itemsPerPage);
         
          if (currentPage < 1) currentPage = 1;
          if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;

          allCards.forEach(card => card.style.display = 'none');

          visibleCards.slice(startIndex, endIndex).forEach(card => {
            card.style.display = 'flex';
            card.style.animation = 'fadeIn 0.5s ease forwards';
          });

          if (productFilter.updateCount) {
            productFilter.updateCount(visibleCards.length);
          }

          if (visibleCards.length > itemsPerPage) {
            paginationContainer.style.display = 'flex';
            paginationInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
          } else {
            paginationContainer.style.display = 'none';
          }

          noResultsMessage.style.display = visibleCards.length === 0 ? 'block' : 'none';
        }

        function applyFilter(filters) {
          visibleCards = allCards.filter(card => {
            const productType = card.getAttribute('data-product-type') || '';
            const productTitle = card.getAttribute('data-product-title') || '';
            const productPrice = parseFloat(card.getAttribute('data-product-price')) || 0;
           
            let matchesCategory = true;
            let matchesSearch = true;
            let matchesPrice = true;

            if (filters.categories && filters.categories.length > 0) {
              matchesCategory = filters.categories.includes(productType);
            }

            if (filters.search && filters.search.length > 0) {
              matchesSearch = productTitle.includes(filters.search.toLowerCase());
            }

            if (filters.priceMin !== undefined && filters.priceMax !== undefined) {
               matchesPrice = productPrice >= filters.priceMin && productPrice <= filters.priceMax;
            }

            return matchesCategory && matchesSearch && matchesPrice;
          });

          currentPage = 1;
          renderPage();
        }

        productFilter.addEventListener('filter-applied', (e) => {
          console.log('üîç Filter applied for section {{ section.id }}:', e.detail);
          applyFilter(e.detail);
        });
       
        productFilter.addEventListener('filter-reset', () => {
          console.log('üîÑ Filter reset for section {{ section.id }}');
          visibleCards = [...allCards];
          currentPage = 1;
          renderPage();
        });

        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderPage();
          }
        });

        nextBtn.addEventListener('click', () => {
          const totalPages = Math.ceil(visibleCards.length / itemsPerPage);
          if (currentPage < totalPages) {
            currentPage++;
            renderPage();
          }
        });

        visibleCards = [...allCards];
        renderPage();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupFilterListeners_{{ safe_id }});
      } else {
        setupFilterListeners_{{ safe_id }}();
      }
    </script>

    <style>
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>

  </div>
</div>

{% schema %}
{
  "name": "Product Filter Section",
  "blocks": [
    {
      "type": "collection_title",
      "name": "Collection Title",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Layout"
        },
        {
          "type": "select",
          "id": "layout",
          "label": "Direction",
          "options": [
            {
              "value": "horizontal",
              "label": "Horizontal"
            },
            {
              "value": "vertical",
              "label": "Vertical"
            }
          ],
          "default": "horizontal",
          "info": "Controls layout direction for all header blocks"
        },
        {
          "type": "select",
          "id": "alignment",
          "label": "Header Alignment",
          "options": [
            {
              "value": "flex-start",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "flex-end",
              "label": "Right"
            },
            {
              "value": "space-between",
              "label": "Space Between"
            }
          ],
          "default": "space-between"
        },
        {
          "type": "range",
          "id": "gap",
          "label": "Gap",
          "min": 0,
          "max": 60,
          "step": 5,
          "unit": "px",
          "default": 15
        },
        {
          "type": "header",
          "content": "Title Settings"
        },
        {
          "type": "select",
          "id": "title_alignment",
          "label": "Title Text Alignment",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "left"
        },
        {
          "type": "range",
          "id": "heading_size",
          "label": "Heading Size",
          "min": 16,
          "max": 64,
          "step": 2,
          "unit": "px",
          "default": 32
        }
      ]
    },
    {
      "type": "view_all_button",
      "name": "View All Button",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Button Position"
        },
        {
          "type": "select",
          "id": "button_alignment",
          "label": "Button Alignment",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "right",
          "info": "Aligns button within its container"
        },
        {
          "type": "header",
          "content": "Button Text"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "default": "View All"
        },
        {
          "type": "checkbox",
          "id": "show_arrow",
          "label": "Show arrow icon",
          "default": true
        },
        {
          "type": "range",
          "id": "button_font_size",
          "label": "Font Size",
          "min": 12,
          "max": 24,
          "step": 1,
          "unit": "px",
          "default": 14
        },
        {
          "type": "header",
          "content": "Button Style"
        },
        {
          "type": "range",
          "id": "button_padding_vertical",
          "label": "Vertical Padding",
          "min": 4,
          "max": 32,
          "step": 2,
          "unit": "px",
          "default": 12
        },
        {
          "type": "range",
          "id": "button_padding_horizontal",
          "label": "Horizontal Padding",
          "min": 8,
          "max": 48,
          "step": 2,
          "unit": "px",
          "default": 24
        },
        {
          "type": "range",
          "id": "button_border_radius",
          "label": "Border Radius",
          "min": 0,
          "max": 50,
          "step": 1,
          "unit": "px",
          "default": 8
        },
        {
          "type": "header",
          "content": "Button Colors"
        },
        {
          "type": "color",
          "id": "button_bg_color",
          "label": "Background Color",
          "default": "#000000"
        },
        {
          "type": "color",
          "id": "button_text_color",
          "label": "Text Color",
          "default": "#ffffff"
        },
        {
          "type": "color",
          "id": "button_bg_color_hover",
          "label": "Background Color (Hover)",
          "default": "#333333"
        },
        {
          "type": "color",
          "id": "button_text_color_hover",
          "label": "Text Color (Hover)",
          "default": "#ffffff"
        },
        {
          "type": "range",
          "id": "button_border_width",
          "label": "Border Width",
          "min": 0,
          "max": 5,
          "step": 1,
          "unit": "px",
          "default": 0
        },
        {
          "type": "color",
          "id": "button_border_color",
          "label": "Border Color",
          "default": "#000000"
        }
      ]
    },
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "header",
      "content": "Product Display"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Products per page",
      "min": 1,
      "max": 50,
      "step": 1,
      "default": 9
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section Width",
      "options": [
        {
          "value": "page-width",
          "label": "Page Width"
        },
        {
          "value": "full-width",
          "label": "Full Width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Grid Gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 24
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Product Filter",
      "category": "Products"
    }
  ]
}
{% endschema %}
